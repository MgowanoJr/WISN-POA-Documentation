<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>wisn-poa documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">wisn-poa documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>WisnReportEffects</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/store/effects/wisn-report.effects.ts</code>
        </p>




            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#analyticsWasFired">analyticsWasFired</a>
                            </li>
                            <li>
                                <a href="#checkingWisnReportState">checkingWisnReportState</a>
                            </li>
                            <li>
                                <a href="#downloadWisnReport$">downloadWisnReport$</a>
                            </li>
                            <li>
                                <a href="#loadingDataBackground$">loadingDataBackground$</a>
                            </li>
                            <li>
                                <a href="#loadWisnReportAnalytics$">loadWisnReportAnalytics$</a>
                            </li>
                            <li>
                                <a href="#todayTimeDate">todayTimeDate</a>
                            </li>
                            <li>
                                <a href="#uploadingWisnReport$">uploadingWisnReport$</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#collectingAllFacilityData">collectingAllFacilityData</a>
                            </li>
                            <li>
                                <a href="#collectingAllFacilityDataInBackgroundMode">collectingAllFacilityDataInBackgroundMode</a>
                            </li>
                            <li>
                                <a href="#generateWISNreportFromLocalStorage">generateWISNreportFromLocalStorage</a>
                            </li>
                            <li>
                                <a href="#uploadDataFromCSV">uploadDataFromCSV</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(actions$: <a href="../undefineds/Actions.html">Actions</a>, wisnAnalyticsService: <a href="../injectables/WisnAnalyticsService.html">WisnAnalyticsService</a>, wisnPoaService: <a href="../injectables/WisnPoaPageService.html">WisnPoaPageService</a>, store: Store<AppState>, localDbService: <a href="../injectables/LocalStorageService.html">LocalStorageService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="61" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:61</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>actions$</td>
                                                  
                                                        <td>
                                                                        <code><a href="../miscellaneous/typealiases.html#Actions" target="_self" >Actions</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>wisnAnalyticsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/WisnAnalyticsService.html" target="_self" >WisnAnalyticsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>wisnPoaService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/WisnPoaPageService.html" target="_self" >WisnPoaPageService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>store</td>
                                                  
                                                        <td>
                                                                    <code>Store&lt;AppState&gt;</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>localDbService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/LocalStorageService.html" target="_self" >LocalStorageService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="collectingAllFacilityData"></a>
                    <span class="name">
                        <b>
                            collectingAllFacilityData
                        </b>
                        <a href="#collectingAllFacilityData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>collectingAllFacilityData(childOrgunits, dataEntryLevel, indicators, selectedOrgunit, period, wisnReportPage, subLevel)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="466"
                            class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:466</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>childOrgunits</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>dataEntryLevel</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>indicators</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>selectedOrgunit</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>period</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>wisnReportPage</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>subLevel</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="collectingAllFacilityDataInBackgroundMode"></a>
                    <span class="name">
                        <b>
                            collectingAllFacilityDataInBackgroundMode
                        </b>
                        <a href="#collectingAllFacilityDataInBackgroundMode"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>collectingAllFacilityDataInBackgroundMode(childOrgunits, dataEntryLevel, indicators, selectedOrgunit, period, wisnReportPage, subLevel)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="619"
                            class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:619</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>childOrgunits</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>dataEntryLevel</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>indicators</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>selectedOrgunit</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>period</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>wisnReportPage</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>subLevel</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="generateWISNreportFromLocalStorage"></a>
                    <span class="name">
                        <b>
                            generateWISNreportFromLocalStorage
                        </b>
                        <a href="#generateWISNreportFromLocalStorage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>generateWISNreportFromLocalStorage(response, wisnReportPage, selectedOrgunit, period, progresPercent, isContinousLoading)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="580"
                            class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:580</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>response</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>wisnReportPage</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>selectedOrgunit</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>period</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>progresPercent</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>isContinousLoading</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="uploadDataFromCSV"></a>
                    <span class="name">
                        <b>
                            uploadDataFromCSV
                        </b>
                        <a href="#uploadDataFromCSV"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>uploadDataFromCSV(wisnReportPage, csvFile, wisnUploadPageData, orgunitChildren, period)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="442"
                            class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:442</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>wisnReportPage</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>csvFile</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>wisnUploadPageData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>orgunitChildren</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>period</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="analyticsWasFired"></a>
                        <span class="name">
                            <b>
                            analyticsWasFired</b>
                            <a href="#analyticsWasFired"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>false</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="54" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:54</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="checkingWisnReportState"></a>
                        <span class="name">
                            <b>
                            checkingWisnReportState</b>
                            <a href="#checkingWisnReportState"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>this.actions$.pipe(
    ofType(WisnReportActionTypes.CheckingWisnReport),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(getCurrentGlobalFilter)
    ),
    map(
      ([action, wisnReport, currentGlobalFilters]: [
        fromWisnReportActions.CheckWisnReportState,
        any,
        any
      ]) &#x3D;&gt; {
        const wisnReportState &#x3D; wisnReport ? wisnReport : {};
        const currentOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const curentPeriod &#x3D; currentGlobalFilters.pe
          ? currentGlobalFilters.pe
          : {};

        if (
          wisnReportState.entities[&#x27;report&#x27;].length &gt; 1 &amp;&amp;
          wisnReportState.lastDataSelection.orgunit &#x3D;&#x3D;&#x3D; currentOrgunit.id &amp;&amp;
          wisnReportState.lastDataSelection.period &#x3D;&#x3D;&#x3D; curentPeriod.id
        ) {
          // do nothing because state info is already there
          return new NoChangesOnWisnReport();
        }
        // dispatch action for loading the wisnReport
        return new LoadWisnReports(); // fire action for loading wisn report
      }
    )
  )</code>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <b>Decorators : </b>
                            <br />
                            <code>
                                @Effect()<br />
                            </code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="71" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:71</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="downloadWisnReport$"></a>
                        <span class="name">
                            <b>
                            downloadWisnReport$</b>
                            <a href="#downloadWisnReport$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>this.actions$.pipe(
    ofType(WisnReportActionTypes.DownLoadWisnReport),
    withLatestFrom(
      this.store.select(getCurrentPage),
      this.store.select(getWisnReportData)
    ),
    map(
      ([action, wisnReportPage, wisnReportStateEntity]: [
        fromWisnReportActions.DownLoadWisnReport,
        any,
        any
      ]) &#x3D;&gt; {
        const isCadreBasedReport &#x3D; action.tableData
          ? action.tableData.length &gt; 0
            ? true
            : false
          : false;
        const cadreObject: any &#x3D; isCadreBasedReport
          ? _.head(action.tableData)
          : null;
        const cadreName &#x3D; cadreObject ? cadreObject.cadre : &#x27;all cadre types&#x27;;
        const wisnReportData &#x3D; isCadreBasedReport
          ? action.tableData
          : wisnReportStateEntity;

        const reportPageStateSubpages &#x3D; wisnReportPage[0].subPages
          ? wisnReportPage[0].subPages
          : [];
        const csvTableHeader &#x3D; isCadreBasedReport
          ? [
              &#x27;Facility&#x27;,
              &#x27;Existing staff&#x27;,
              &#x27;Calculated staff requirement&#x27;,
              &#x27;WISN Ratio&#x27;
            ]
          : [
              &#x27;Facility&#x27;,
              &#x27;Cadre&#x27;,
              &#x27;Existing staff&#x27;,
              &#x27;Calculated staff requirement&#x27;,
              &#x27;WISN Ratio&#x27;
            ];

        const csvRows &#x3D; fromWisnReportHelper.generateWisnReportCSVrows(
          wisnReportData,
          isCadreBasedReport,
          reportPageStateSubpages
        );
        const row &#x3D; [csvTableHeader, ...csvRows];
        let csvContent &#x3D;
          &#x27;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset&#x3D;utf-8,&#x27;;
        row.forEach(function(rowArray) {
          const rowEntry &#x3D; rowArray.join(&#x27;,&#x27;);
          csvContent +&#x3D; rowEntry + &#x27;\r\n&#x27;;
        });
        const dateTime &#x3D; new Date();
        const filename &#x3D;
          &#x27;WISN Report for &#x27; +
          cadreName +
          &#x27; - gen. on &#x27; +
          dateTime.getFullYear() +
          (dateTime.getMonth() + 1 &lt; 10 ? &#x27;-0&#x27; : &#x27;-&#x27;) +
          (dateTime.getMonth() + 1) +
          (dateTime.getDay() &lt; 10 ? &#x27;-0&#x27; : &#x27;-&#x27;) +
          dateTime.getDay() +
          &#x27; &#x27; +
          (dateTime.getHours() &lt; 10 ? &#x27;:0&#x27; : &#x27;:&#x27;) +
          dateTime.getHours() +
          (dateTime.getMinutes() &lt; 10 ? &#x27;:0&#x27; : &#x27;:&#x27;) +
          dateTime.getMinutes() +
          &#x27; hrs.xls&#x27;;
        const encodedUri &#x3D; encodeURI(csvContent);
        const link &#x3D; document.createElement(&#x27;a&#x27;);
        link.setAttribute(&#x27;href&#x27;, encodedUri);
        link.setAttribute(&#x27;download&#x27;, filename);
        link.click();

        return new CompleteDownLoadWisnReport();
      }
    )
  )</code>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <b>Decorators : </b>
                            <br />
                            <code>
                                @Effect()<br />
                            </code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="260" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:260</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="loadingDataBackground$"></a>
                        <span class="name">
                            <b>
                            loadingDataBackground$</b>
                            <a href="#loadingDataBackground$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>this.actions$.pipe(
    ofType(WisnReportActionTypes.WisnDataUpdateInBackground),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(getCurrentGlobalFilter),
      this.store.select(getDataEntryLevelState),
      this.store.select(getCurrentUser),
      this.store.select(getPageData(&#x27;wisnreport&#x27;))
    ),
    tap(
      ([
        action,
        wisnReport,
        currentGlobalFilters,
        dataEntryOrgUnitLevel,
        currentUserData,
        wisnreportPage
      ]: [
        fromWisnReportActions.WisnDataUpdateInBackground,
        any,
        any,
        any,
        any,
        any
      ]) &#x3D;&gt; {
        // checks before whether is wisn-report still fetching data if no then starts to update indexDB data
        if (wisnReport.iswisnReportFetchingData &#x3D;&#x3D;&#x3D; false) {
          console.log(&#x27;[WISN+POA] Background data fetch initaited...&#x27;);
          const selectedOrgunit &#x3D; currentGlobalFilters.ou
            ? currentGlobalFilters.ou
            : {};
          const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
          const wisnReportPage &#x3D; wisnreportPage[0] ? wisnreportPage[0] : {};
          const currentUser &#x3D; currentUserData ? currentUserData : {};
          const dataEntryLevel &#x3D; dataEntryOrgUnitLevel
            ? dataEntryOrgUnitLevel
            : 4;
          const userOrgunitsForCollectingOfflineData &#x3D; fromWisnReportHelper.getDatadimensionsForAnalytics(
            currentUser.organisationUnits
          );
          const analyticsIndicators &#x3D; fromWisnReportHelper.getAnalyticsIndicators(
            wisnReportPage.subPages
          );
          const subLevel &#x3D; fromWisnReportHelper.getOrgunitSublevelForAnalysis(
            dataEntryLevel,
            selectedOrgunit.level
          );
          this.collectingAllFacilityDataInBackgroundMode(
            userOrgunitsForCollectingOfflineData,
            dataEntryLevel,
            analyticsIndicators,
            selectedOrgunit,
            period,
            wisnReportPage,
            subLevel
          );
        } else {
          console.log(
            &#x27;Background-Data fetch failed to initaite due to currently WISN report is still fetching data.&#x27;
          );
        }
      }
    )
  )</code>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <b>Decorators : </b>
                            <br />
                            <code>
                                @Effect({dispatch: false})<br />
                            </code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="194" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:194</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="loadWisnReportAnalytics$"></a>
                        <span class="name">
                            <b>
                            loadWisnReportAnalytics$</b>
                            <a href="#loadWisnReportAnalytics$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>this.actions$.pipe(
    ofType(WisnReportActionTypes.LoadWisnReports),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(fromWisnPoaPagesSelectors.getWisnReportPageData),
      this.store.select(getCurrentGlobalFilter),
      this.store.select(getDataEntryLevelState),
      this.store.select(getCurrentUser)
    ),
    tap(
      ([
        action,
        wisnReport,
        wisnReportPage,
        currentGlobalFilters,
        dataEntryOrgUnitLevel,
        currentUserData
      ]: [fromWisnReportActions.LoadWisnReports, any, any, any, any, any]) &#x3D;&gt; {
        const selectedOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
        const wisnReportState &#x3D; wisnReport ? wisnReport : {};
        const dataEntryLevel &#x3D; dataEntryOrgUnitLevel
          ? dataEntryOrgUnitLevel
          : 4;
        const currentUser &#x3D; currentUserData ? currentUserData : {};
        const userOrgunitsForCollectingOfflineData &#x3D; fromWisnReportHelper.getDatadimensionsForAnalytics(
          currentUser.organisationUnits
        );
        const analyticsIndicators &#x3D; fromWisnReportHelper.getAnalyticsIndicators(
          wisnReportPage[0] ? wisnReportPage[0].subPages : []
        );
        this.analyticsWasFired &#x3D; false;
        const subLevel &#x3D; fromWisnReportHelper.getOrgunitSublevelForAnalysis(
          dataEntryLevel,
          selectedOrgunit.level
        );

        if (wisnReportState.iswisnReportFetchingData) {
          // don&#x27;t do anything because the report is still fetching data
        } else {
          this.localDbService
            .getByKey(WISN_REPORT_ANALYTICS, &#x27;analytics_&#x27; + period.id)
            .subscribe(
              (response: any) &#x3D;&gt; {
                const offlineAnalyticsPeriod &#x3D; response
                  ? response.metaData.dimensions.pe[0]
                  : &#x27;&#x27;;
                if (response &amp;&amp; offlineAnalyticsPeriod &#x3D;&#x3D;&#x3D; period.id) {
                  const progressCounter &#x3D; 0;
                  this.store.dispatch(
                    new WisnProgressLoaderUpdate({
                      progress: progressCounter,
                      iswisnReportFetchingData: true,
                      notification: &#x27;Generating WISN Report...&#x27;
                    })
                  );
                  this.generateWISNreportFromLocalStorage(
                    response,
                    wisnReportPage[0],
                    selectedOrgunit,
                    period,
                    100,
                    false
                  );
                } else {
                  if (!this.analyticsWasFired) {
                    this.collectingAllFacilityData(
                      userOrgunitsForCollectingOfflineData,
                      dataEntryLevel,
                      analyticsIndicators,
                      selectedOrgunit,
                      period,
                      wisnReportPage[0],
                      subLevel
                    );
                  }
                }
              },
              error &#x3D;&gt; {}
            );
        }
      }
    )
  )</code>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <b>Decorators : </b>
                            <br />
                            <code>
                                @Effect({dispatch: false})<br />
                            </code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="106" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:106</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="todayTimeDate"></a>
                        <span class="name">
                            <b>
                            todayTimeDate</b>
                            <a href="#todayTimeDate"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>&#x27;&#x27; +
    new Date().getFullYear() +
    &#x27;-&#x27; +
    (1 + new Date().getMonth()) +
    &#x27;-&#x27; +
    new Date().getDate()</code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="55" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:55</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="uploadingWisnReport$"></a>
                        <span class="name">
                            <b>
                            uploadingWisnReport$</b>
                            <a href="#uploadingWisnReport$"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Default value : </i><code>this.actions$.pipe(
    ofType(WisnReportActionTypes.UploadWisnReport),
    withLatestFrom(
      this.store.select(fromWisnPoaPagesSelectors.getWisnReportPageData),
      this.store.select(getCurrentGlobalFilter)
    ),
    tap(
      ([action, wisnReportPageState, currentGlobalFilters]: [
        fromWisnReportActions.UploadWisnReport,
        any,
        any
      ]) &#x3D;&gt; {
        const selectedOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
        const wisnReportSubPage &#x3D; wisnReportPageState.subPages
          ? wisnReportPageState.subPages
          : [];
        const winsUploads &#x3D; wisnReportPageState.uploads
          ? wisnReportPageState.uploads
          : {};
        const csvData &#x3D; action.payload ? action.payload : [];
        const wisnReportPage &#x3D; wisnReportPageState ? wisnReportPageState : {};
        const uploadedRestructured &#x3D; fromWisnReportHelper.getStructedWisnReportFromUpload(
          csvData,
          wisnReportSubPage,
          selectedOrgunit
        );
        const lastDataSelection &#x3D; {
          orgunit: selectedOrgunit.id,
          period: period.id
        };
        this.store.dispatch(
          new CompleteUpLoadingWisnReport({
            lastDataSelection: lastDataSelection,
            wisnOutputs: uploadedRestructured
          })
        );
        // will prepare data for uploading to dataSet for uploaded data WISN report
        this.uploadDataFromCSV(
          wisnReportPage,
          csvData,
          winsUploads,
          selectedOrgunit.children,
          period.id
        );
      }
    )
  )</code>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <b>Decorators : </b>
                            <br />
                            <code>
                                @Effect()<br />
                            </code>
                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="343" class="link-to-prism">src/app/store/effects/wisn-report.effects.ts:343</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import { Actions, Effect, ofType } from &#x27;@ngrx/effects&#x27;;
import {
  AddWisnReport,
  CompleteDownLoadWisnReport,
  CompleteUpLoadingWisnReport,
  DeleteWisnReports,
  LoadWisnReports,
  NoChangesOnWisnReport,
  UpsertWisnReport,
  WisnErrorHandler,
  WisnProgressLoaderUpdate,
  WisnReportActionTypes
} from &#x27;../actions/wisn-report.actions&#x27;;
import {
  catchError,
  map,
  mergeMap,
  switchMap,
  tap,
  withLatestFrom
} from &#x27;rxjs/operators&#x27;;
import { WisnAnalyticsService } from &#x27;../../shared/services/wisn-analytics.service&#x27;;
import { State, Store } from &#x27;@ngrx/store&#x27;;
import { AppState, getWisnReportState } from &#x27;../reducers&#x27;;
import * as fromWisnReportActions from &#x27;../actions/wisn-report.actions&#x27;;
import { of } from &#x27;rxjs&#x27;;
import * as _ from &#x27;lodash&#x27;;
import {
  getCurrentPage,
  getWisnReportPageData,
  getPageData
} from &#x27;../selectors/wisn-poa-pages.selectors&#x27;;
import { WisnPresetValueActionTypes } from &#x27;../actions/wisn-preset-value.actions&#x27;;
import { calculatedStaffRequirementIndicators } from &#x27;../../../assets/configurations/calculatedStaffRequirementIndicators&#x27;;
import * as fromWisnReportSelectors from &#x27;../selectors/wisn-report.selectors&#x27;;
import * as fromWisnPresetValuesSelectors from &#x27;../selectors/preset-values.selectors&#x27;;
import * as fromWisnHrhSelectors from &#x27;../selectors/wisn-hrh.selectors&#x27;;
import * as fromWisnPoaPagesSelectors from &#x27;../selectors/wisn-poa-pages.selectors&#x27;;
import { WisnPoaPageService } from &#x27;../../shared/services/wisn-poa-page.service&#x27;;
import {
  LocalStorageService,
  WISN_REPORT_ANALYTICS
} from &#x27;../../shared/services/local-storage.service&#x27;;
import * as fromUtilHelpers from &#x27;../../shared/helpers/util-functions&#x27;;
import { getWisnReportData } from &#x27;../selectors/wisn-report.selectors&#x27;;
import * as fromWisnReportHelper from &#x27;../../shared/helpers/wisn-report.helpers&#x27;;
import { getCurrentGlobalFilter } from &#x27;../selectors/global-filter.selectors&#x27;;
import { getDataEntryLevelState } from &#x27;../selectors/general-configuration.selector&#x27;;
import { getCurrentUser } from &#x27;../selectors&#x27;;

@Injectable()
export class WisnReportEffects {
  analyticsWasFired &#x3D; false;
  todayTimeDate: string &#x3D;
    &#x27;&#x27; +
    new Date().getFullYear() +
    &#x27;-&#x27; +
    (1 + new Date().getMonth()) +
    &#x27;-&#x27; +
    new Date().getDate();
  constructor(
    private actions$: Actions,
    private wisnAnalyticsService: WisnAnalyticsService,
    private wisnPoaService: WisnPoaPageService,
    private store: Store&lt;AppState&gt;,
    private localDbService: LocalStorageService
  ) {}

  @Effect()
  checkingWisnReportState &#x3D; this.actions$.pipe(
    ofType(WisnReportActionTypes.CheckingWisnReport),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(getCurrentGlobalFilter)
    ),
    map(
      ([action, wisnReport, currentGlobalFilters]: [
        fromWisnReportActions.CheckWisnReportState,
        any,
        any
      ]) &#x3D;&gt; {
        const wisnReportState &#x3D; wisnReport ? wisnReport : {};
        const currentOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const curentPeriod &#x3D; currentGlobalFilters.pe
          ? currentGlobalFilters.pe
          : {};

        if (
          wisnReportState.entities[&#x27;report&#x27;].length &gt; 1 &amp;&amp;
          wisnReportState.lastDataSelection.orgunit &#x3D;&#x3D;&#x3D; currentOrgunit.id &amp;&amp;
          wisnReportState.lastDataSelection.period &#x3D;&#x3D;&#x3D; curentPeriod.id
        ) {
          // do nothing because state info is already there
          return new NoChangesOnWisnReport();
        }
        // dispatch action for loading the wisnReport
        return new LoadWisnReports(); // fire action for loading wisn report
      }
    )
  );

  @Effect({ dispatch: false })
  loadWisnReportAnalytics$ &#x3D; this.actions$.pipe(
    ofType(WisnReportActionTypes.LoadWisnReports),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(fromWisnPoaPagesSelectors.getWisnReportPageData),
      this.store.select(getCurrentGlobalFilter),
      this.store.select(getDataEntryLevelState),
      this.store.select(getCurrentUser)
    ),
    tap(
      ([
        action,
        wisnReport,
        wisnReportPage,
        currentGlobalFilters,
        dataEntryOrgUnitLevel,
        currentUserData
      ]: [fromWisnReportActions.LoadWisnReports, any, any, any, any, any]) &#x3D;&gt; {
        const selectedOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
        const wisnReportState &#x3D; wisnReport ? wisnReport : {};
        const dataEntryLevel &#x3D; dataEntryOrgUnitLevel
          ? dataEntryOrgUnitLevel
          : 4;
        const currentUser &#x3D; currentUserData ? currentUserData : {};
        const userOrgunitsForCollectingOfflineData &#x3D; fromWisnReportHelper.getDatadimensionsForAnalytics(
          currentUser.organisationUnits
        );
        const analyticsIndicators &#x3D; fromWisnReportHelper.getAnalyticsIndicators(
          wisnReportPage[0] ? wisnReportPage[0].subPages : []
        );
        this.analyticsWasFired &#x3D; false;
        const subLevel &#x3D; fromWisnReportHelper.getOrgunitSublevelForAnalysis(
          dataEntryLevel,
          selectedOrgunit.level
        );

        if (wisnReportState.iswisnReportFetchingData) {
          // don&#x27;t do anything because the report is still fetching data
        } else {
          this.localDbService
            .getByKey(WISN_REPORT_ANALYTICS, &#x27;analytics_&#x27; + period.id)
            .subscribe(
              (response: any) &#x3D;&gt; {
                const offlineAnalyticsPeriod &#x3D; response
                  ? response.metaData.dimensions.pe[0]
                  : &#x27;&#x27;;
                if (response &amp;&amp; offlineAnalyticsPeriod &#x3D;&#x3D;&#x3D; period.id) {
                  const progressCounter &#x3D; 0;
                  this.store.dispatch(
                    new WisnProgressLoaderUpdate({
                      progress: progressCounter,
                      iswisnReportFetchingData: true,
                      notification: &#x27;Generating WISN Report...&#x27;
                    })
                  );
                  this.generateWISNreportFromLocalStorage(
                    response,
                    wisnReportPage[0],
                    selectedOrgunit,
                    period,
                    100,
                    false
                  );
                } else {
                  if (!this.analyticsWasFired) {
                    this.collectingAllFacilityData(
                      userOrgunitsForCollectingOfflineData,
                      dataEntryLevel,
                      analyticsIndicators,
                      selectedOrgunit,
                      period,
                      wisnReportPage[0],
                      subLevel
                    );
                  }
                }
              },
              error &#x3D;&gt; {}
            );
        }
      }
    )
  );

  @Effect({ dispatch: false })
  loadingDataBackground$ &#x3D; this.actions$.pipe(
    ofType(WisnReportActionTypes.WisnDataUpdateInBackground),
    withLatestFrom(
      this.store.select(getWisnReportState),
      this.store.select(getCurrentGlobalFilter),
      this.store.select(getDataEntryLevelState),
      this.store.select(getCurrentUser),
      this.store.select(getPageData(&#x27;wisnreport&#x27;))
    ),
    tap(
      ([
        action,
        wisnReport,
        currentGlobalFilters,
        dataEntryOrgUnitLevel,
        currentUserData,
        wisnreportPage
      ]: [
        fromWisnReportActions.WisnDataUpdateInBackground,
        any,
        any,
        any,
        any,
        any
      ]) &#x3D;&gt; {
        // checks before whether is wisn-report still fetching data if no then starts to update indexDB data
        if (wisnReport.iswisnReportFetchingData &#x3D;&#x3D;&#x3D; false) {
          console.log(&#x27;[WISN+POA] Background data fetch initaited...&#x27;);
          const selectedOrgunit &#x3D; currentGlobalFilters.ou
            ? currentGlobalFilters.ou
            : {};
          const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
          const wisnReportPage &#x3D; wisnreportPage[0] ? wisnreportPage[0] : {};
          const currentUser &#x3D; currentUserData ? currentUserData : {};
          const dataEntryLevel &#x3D; dataEntryOrgUnitLevel
            ? dataEntryOrgUnitLevel
            : 4;
          const userOrgunitsForCollectingOfflineData &#x3D; fromWisnReportHelper.getDatadimensionsForAnalytics(
            currentUser.organisationUnits
          );
          const analyticsIndicators &#x3D; fromWisnReportHelper.getAnalyticsIndicators(
            wisnReportPage.subPages
          );
          const subLevel &#x3D; fromWisnReportHelper.getOrgunitSublevelForAnalysis(
            dataEntryLevel,
            selectedOrgunit.level
          );
          this.collectingAllFacilityDataInBackgroundMode(
            userOrgunitsForCollectingOfflineData,
            dataEntryLevel,
            analyticsIndicators,
            selectedOrgunit,
            period,
            wisnReportPage,
            subLevel
          );
        } else {
          console.log(
            &#x27;Background-Data fetch failed to initaite due to currently WISN report is still fetching data.&#x27;
          );
        }
      }
    )
  );

  @Effect()
  downloadWisnReport$ &#x3D; this.actions$.pipe(
    ofType(WisnReportActionTypes.DownLoadWisnReport),
    withLatestFrom(
      this.store.select(getCurrentPage),
      this.store.select(getWisnReportData)
    ),
    map(
      ([action, wisnReportPage, wisnReportStateEntity]: [
        fromWisnReportActions.DownLoadWisnReport,
        any,
        any
      ]) &#x3D;&gt; {
        const isCadreBasedReport &#x3D; action.tableData
          ? action.tableData.length &gt; 0
            ? true
            : false
          : false;
        const cadreObject: any &#x3D; isCadreBasedReport
          ? _.head(action.tableData)
          : null;
        const cadreName &#x3D; cadreObject ? cadreObject.cadre : &#x27;all cadre types&#x27;;
        const wisnReportData &#x3D; isCadreBasedReport
          ? action.tableData
          : wisnReportStateEntity;

        const reportPageStateSubpages &#x3D; wisnReportPage[0].subPages
          ? wisnReportPage[0].subPages
          : [];
        const csvTableHeader &#x3D; isCadreBasedReport
          ? [
              &#x27;Facility&#x27;,
              &#x27;Existing staff&#x27;,
              &#x27;Calculated staff requirement&#x27;,
              &#x27;WISN Ratio&#x27;
            ]
          : [
              &#x27;Facility&#x27;,
              &#x27;Cadre&#x27;,
              &#x27;Existing staff&#x27;,
              &#x27;Calculated staff requirement&#x27;,
              &#x27;WISN Ratio&#x27;
            ];

        const csvRows &#x3D; fromWisnReportHelper.generateWisnReportCSVrows(
          wisnReportData,
          isCadreBasedReport,
          reportPageStateSubpages
        );
        const row &#x3D; [csvTableHeader, ...csvRows];
        let csvContent &#x3D;
          &#x27;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset&#x3D;utf-8,&#x27;;
        row.forEach(function(rowArray) {
          const rowEntry &#x3D; rowArray.join(&#x27;,&#x27;);
          csvContent +&#x3D; rowEntry + &#x27;\r\n&#x27;;
        });
        const dateTime &#x3D; new Date();
        const filename &#x3D;
          &#x27;WISN Report for &#x27; +
          cadreName +
          &#x27; - gen. on &#x27; +
          dateTime.getFullYear() +
          (dateTime.getMonth() + 1 &lt; 10 ? &#x27;-0&#x27; : &#x27;-&#x27;) +
          (dateTime.getMonth() + 1) +
          (dateTime.getDay() &lt; 10 ? &#x27;-0&#x27; : &#x27;-&#x27;) +
          dateTime.getDay() +
          &#x27; &#x27; +
          (dateTime.getHours() &lt; 10 ? &#x27;:0&#x27; : &#x27;:&#x27;) +
          dateTime.getHours() +
          (dateTime.getMinutes() &lt; 10 ? &#x27;:0&#x27; : &#x27;:&#x27;) +
          dateTime.getMinutes() +
          &#x27; hrs.xls&#x27;;
        const encodedUri &#x3D; encodeURI(csvContent);
        const link &#x3D; document.createElement(&#x27;a&#x27;);
        link.setAttribute(&#x27;href&#x27;, encodedUri);
        link.setAttribute(&#x27;download&#x27;, filename);
        link.click();

        return new CompleteDownLoadWisnReport();
      }
    )
  );

  @Effect()
  uploadingWisnReport$ &#x3D; this.actions$.pipe(
    ofType(WisnReportActionTypes.UploadWisnReport),
    withLatestFrom(
      this.store.select(fromWisnPoaPagesSelectors.getWisnReportPageData),
      this.store.select(getCurrentGlobalFilter)
    ),
    tap(
      ([action, wisnReportPageState, currentGlobalFilters]: [
        fromWisnReportActions.UploadWisnReport,
        any,
        any
      ]) &#x3D;&gt; {
        const selectedOrgunit &#x3D; currentGlobalFilters.ou
          ? currentGlobalFilters.ou
          : {};
        const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
        const wisnReportSubPage &#x3D; wisnReportPageState.subPages
          ? wisnReportPageState.subPages
          : [];
        const winsUploads &#x3D; wisnReportPageState.uploads
          ? wisnReportPageState.uploads
          : {};
        const csvData &#x3D; action.payload ? action.payload : [];
        const wisnReportPage &#x3D; wisnReportPageState ? wisnReportPageState : {};
        const uploadedRestructured &#x3D; fromWisnReportHelper.getStructedWisnReportFromUpload(
          csvData,
          wisnReportSubPage,
          selectedOrgunit
        );
        const lastDataSelection &#x3D; {
          orgunit: selectedOrgunit.id,
          period: period.id
        };
        this.store.dispatch(
          new CompleteUpLoadingWisnReport({
            lastDataSelection: lastDataSelection,
            wisnOutputs: uploadedRestructured
          })
        );
        // will prepare data for uploading to dataSet for uploaded data WISN report
        this.uploadDataFromCSV(
          wisnReportPage,
          csvData,
          winsUploads,
          selectedOrgunit.children,
          period.id
        );
      }
    )
  );

  // @Effect({dispatch: false})
  // updateWisnReportIndicators$ &#x3D; this.actions$.pipe(
  //   ofType(WisnReportActionTypes.UpdateWisnReportFromDataValues),
  //   withLatestFrom(this.store.select(
  //     fromWisnReportSelectors.getWisnReportEntities
  //   ), this.store.select(
  //     fromWisnPresetValuesSelectors.getFacilitiesDataValues
  //   ), this.store.select(
  //     fromWisnHrhSelectors.getWisnHrhDataEntities
  //   ), this.store.select(
  //     fromWisnPoaPagesSelectors.getHrhPageData
  //   ), this.store.select(
  //     fromWisnPoaPagesSelectors.getWisnReportPageData),
  //     this.store.select(getCurrentGlobalFilter)),
  //   tap(([action, wisnReportStateEntity, collectedDataValues, hrhDataState, hrhWisnReportMapper, wisnReportPage, currentGlobalFilters]:
  //          [fromWisnReportActions.UpdateWisnReportFromDataValues, any, any, any, any, any, any]) &#x3D;&gt; {
  //     const selectedOrgunit &#x3D; currentGlobalFilters.ou ? currentGlobalFilters.ou : {};
  //     const period &#x3D; currentGlobalFilters.pe ? currentGlobalFilters.pe : {};
  //     const hrhWisnReportIdentifiers &#x3D; hrhWisnReportMapper[0].hrh_wisnReportId
  //       ? hrhWisnReportMapper[0].hrh_wisnReportId : {};
  //     const winsStaffIndicators &#x3D; calculatedStaffRequirementIndicators ? calculatedStaffRequirementIndicators : [];
  //     const dataValuesCollection &#x3D; collectedDataValues ? collectedDataValues : [];
  //     const cadreIndicatorMapper &#x3D; {};
  //     let updatedWisnReportData &#x3D; [];
  //     if (wisnReportPage[0].subPages) {
  //       wisnReportPage[0].subPages.forEach((page: any) &#x3D;&gt; {
  //         cadreIndicatorMapper[page.id] &#x3D; page.dataSource[2].id;
  //       });
  //       updatedWisnReportData &#x3D; fromWisnReportHelper.updateWisnReportfromDatavalues(
  //         wisnReportStateEntity.report, hrhDataState ? hrhDataState : [], hrhWisnReportIdentifiers,
  //         dataValuesCollection, winsStaffIndicators, cadreIndicatorMapper);

  //       const lastDataSelection &#x3D; {
  //         orgunit: selectedOrgunit.id,
  //         period: period.id
  //       };
  //       this.store.dispatch(new AddWisnReport({
  //         lastDataSelection: lastDataSelection,
  //         wisnOutputs: updatedWisnReportData,
  //         iswisnReportFetchingData: true
  //       }));
  //       // console.log(JSON.stringify(wisnReportState.report))
  //     } else {
  //       alert(&#x27;Please Load WISN report first.&#x27;);
  //     }
  //   })
  // );

  uploadDataFromCSV(
    wisnReportPage,
    csvFile,
    wisnUploadPageData,
    orgunitChildren,
    period
  ) {
    const dataValuesCollections &#x3D; fromWisnReportHelper.generateDataValuesFromCSV(
      orgunitChildren,
      csvFile,
      wisnReportPage,
      wisnUploadPageData,
      period
    );

    this.wisnAnalyticsService
      .uploadWisnDataFromCSV(dataValuesCollections)
      .subscribe(
        (response: any) &#x3D;&gt; {},
        error &#x3D;&gt; this.store.dispatch(new WisnErrorHandler(error))
      );
  }

  // this function its a reverse i.e accepts single orgunit and gets array[] of indicators
  collectingAllFacilityData(
    childOrgunits,
    dataEntryLevel,
    indicators,
    selectedOrgunit,
    period,
    wisnReportPage,
    subLevel
  ) {
    this.analyticsWasFired &#x3D; true;
    const orgunitDxArray &#x3D; [];
    childOrgunits.forEach((orgunit: any) &#x3D;&gt; {
      indicators.forEach((indicator: any) &#x3D;&gt; {
        orgunitDxArray.push({
          orgunitId: orgunit.id,
          dataElementId: indicator.id
        });
      });
    });
    let capturedAnalytics &#x3D; {
      id: &#x27;analytics_&#x27; + period.id,
      headers: [],
      metaData: {
        ouHierarchy: {},
        items: {},
        dimensions: { dx: [], pe: [], ou: [], co: [] }
      },
      rows: []
    };
    let progressNumerator &#x3D; 0;
    const progressDenominator &#x3D; orgunitDxArray.length;
    this.wisnAnalyticsService
      .getSingleIndicatorWisnReportAnalytics(
        orgunitDxArray,
        dataEntryLevel,
        selectedOrgunit,
        period.id
      )
      .subscribe((analytics: any) &#x3D;&gt; {
        // this function accumulates received &amp; exisiting analytics payloads
        capturedAnalytics &#x3D; fromWisnReportHelper.accumulateAnalyticsPayload(
          analytics,
          capturedAnalytics,
          period
        );
        // this point we have to update localStorage with this new combined analytics
        progressNumerator +&#x3D; 1;
        const progresPercent: any &#x3D; (
          (progressNumerator / progressDenominator) *
          100
        ).toFixed(1);
        this.store.dispatch(
          new WisnProgressLoaderUpdate({
            progress: progresPercent,
            iswisnReportFetchingData: true,
            notification: &#x27;Loading please wait...&#x27;
          })
        );

        if (progresPercent &gt; 25 &amp;&amp; progresPercent &lt; 26) {
          this.generateWISNreportFromLocalStorage(
            capturedAnalytics,
            wisnReportPage,
            selectedOrgunit,
            period,
            progresPercent,
            true
          );
        } else if (progresPercent &gt; 50 &amp;&amp; progresPercent &lt; 51) {
          this.generateWISNreportFromLocalStorage(
            capturedAnalytics,
            wisnReportPage,
            selectedOrgunit,
            period,
            progresPercent,
            true
          );
        } else if (progresPercent &gt; 75 &amp;&amp; progresPercent &lt; 76) {
          this.generateWISNreportFromLocalStorage(
            capturedAnalytics,
            wisnReportPage,
            selectedOrgunit,
            period,
            progresPercent,
            true
          );
        } else if (progressNumerator &#x3D;&#x3D;&#x3D; progressDenominator) {
          this.generateWISNreportFromLocalStorage(
            capturedAnalytics,
            wisnReportPage,
            selectedOrgunit,
            period,
            progresPercent,
            false
          );
          this.localDbService
            .add(WISN_REPORT_ANALYTICS, capturedAnalytics)
            .subscribe();
          // rest capturedAnalytics variable to release memory
          capturedAnalytics &#x3D; {
            id: &#x27;analytics_&#x27; + period.id,
            headers: [],
            metaData: {
              ouHierarchy: {},
              items: {},
              dimensions: { dx: [], pe: [], ou: [], co: [] }
            },
            rows: []
          };
        }
      });
  }

  // this function will utilize the combined analytic payload and utlize it to generate winsReport
  generateWISNreportFromLocalStorage(
    response,
    wisnReportPage,
    selectedOrgunit,
    period,
    progresPercent,
    isContinousLoading
  ) {
    const wisnReportData &#x3D; fromWisnReportHelper.generateWisnReportFromAnalytics(
      response,
      wisnReportPage,
      selectedOrgunit
    );
    const lastDataSelection &#x3D; {
      orgunit: selectedOrgunit.id,
      period: period.id
    };
    if (!isContinousLoading) {
      this.store.dispatch(
        new AddWisnReport({
          lastDataSelection: lastDataSelection,
          wisnOutputs: wisnReportData,
          progressLoader: progresPercent,
          iswisnReportFetchingData: isContinousLoading
        })
      );
    } else {
      this.store.dispatch(
        new UpsertWisnReport({
          lastDataSelection: lastDataSelection,
          data: wisnReportData,
          progressLoader: progresPercent,
          iswisnReportFetchingData: isContinousLoading
        })
      );
    }
  }

  // this function its a reverse i.e accepts single orgunit and gets array[] of indicators
  collectingAllFacilityDataInBackgroundMode(
    childOrgunits,
    dataEntryLevel,
    indicators,
    selectedOrgunit,
    period,
    wisnReportPage,
    subLevel
  ) {
    this.analyticsWasFired &#x3D; true;
    const orgunitDxArray &#x3D; [];
    childOrgunits.forEach((orgunit: any) &#x3D;&gt; {
      indicators.forEach((indicator: any) &#x3D;&gt; {
        orgunitDxArray.push({
          orgunitId: orgunit.id,
          dataElementId: indicator.id
        });
      });
    });
    let capturedAnalytics &#x3D; {
      id: &#x27;analytics_&#x27; + period.id,
      headers: [],
      metaData: {
        ouHierarchy: {},
        items: {},
        dimensions: { dx: [], pe: [], ou: [], co: [] }
      },
      rows: []
    };
    let progressNumerator &#x3D; 0;
    const progressDenominator &#x3D; orgunitDxArray.length;
    this.wisnAnalyticsService
      .getSingleIndicatorWisnReportAnalytics(
        orgunitDxArray,
        dataEntryLevel,
        selectedOrgunit,
        period.id
      )
      .subscribe((analytics: any) &#x3D;&gt; {
        capturedAnalytics &#x3D; fromWisnReportHelper.accumulateAnalyticsPayload(
          analytics,
          capturedAnalytics,
          period
        );
        // this point we have to update localStorage with this new combined analytics
        progressNumerator +&#x3D; 1;
        // this will re-initiate loading of wisn-report hence will pick from indexDB
        if (progressNumerator &#x3D;&#x3D;&#x3D; progressDenominator) {
          console.log(&#x27;[WISN+POA] Background data finalized.&#x27;);
          this.generateWISNreportFromLocalStorage(
            capturedAnalytics,
            wisnReportPage,
            selectedOrgunit,
            period,
            100,
            false
          );
          this.localDbService
            .delete(WISN_REPORT_ANALYTICS, &#x27;id&#x27;)
            .subscribe(response &#x3D;&gt; {
              this.localDbService
                .add(WISN_REPORT_ANALYTICS, capturedAnalytics)
                .subscribe();
              // rest capturedAnalytics variable to release memory
              capturedAnalytics &#x3D; {
                id: &#x27;analytics_&#x27; + period.id,
                headers: [],
                metaData: {
                  ouHierarchy: {},
                  items: {},
                  dimensions: { dx: [], pe: [], ou: [], co: [] }
                },
                rows: []
              };
            });
          // dispatch loading again of wisn-report data
          this.store.dispatch(new LoadWisnReports());
        }
      });
  }
}
</code></pre>
    </div>

</div>











                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'WisnReportEffects.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
